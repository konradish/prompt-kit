name,layer,intent,subject_id,dedupe_key,idempotency_scope,inputs,dependencies,effects,invariants,mode,consistency_window_s,retry_policy,timeout_s,sla_p95_ms,pii_surface,redaction_rules,owner,event_emits,event_consumes,state_model_ref,tenancy_scope,authz_policy_ref,observability_metric,alert_rule,rollback_ref,cache_keys,data_retention
email-ingest,backend,ingest_email,email.message_id,email.message_id + received_at,GLOBAL,"from:string,to:string,subject:string,body:string,message_id:string","emails:MUTATES,idempotency_ledger:MUTATES","db:INSERT:emails:EXACTLY_ONCE_PER_KEY,event:PUBLISH:email.ingested.v1:EXACTLY_ONCE_PER_KEY","No duplicate emails per message_id; Email stored before event emitted","DRY_RUN,FULL",300,"max:3,retryable:[PG_SERIALIZATION,PG_DEADLOCK],backoff:EXP",10,250,HIGH,"redact:body,redact:subject",platform-team,email.ingested.v1,,email.state.md,USER,policies/user-data-access.yaml,email_ingest_success_total,rate(email_ingest_errors_total[5m]) > 0.05,runbooks/email-ingest-rollback.md,user:{user_id}:emails,emails:90d
email-search,backend,search_emails,"user_id + query_hash",,,user_id:uuid,emails:READONLY,"db:SELECT:emails:AT_LEAST_ONCE_PER_KEY,cache:GET:search_results:AT_LEAST_ONCE_PER_KEY","Results match query; No emails from other users visible",,30,,,100,MED,redact:email_preview,platform-team,,,,USER,policies/user-data-access.yaml,email_search_latency_p95,email_search_latency_p95 > 200,runbooks/email-search-degradation.md,"user:{user_id}:search:{query_hash}",search_cache:1h
email-send,backend,send_email,email.draft_id,email.draft_id + send_attempt,"SUBJECT:draft_id","draft_id:uuid,to:string,subject:string,body:string","drafts:READONLY,sent_emails:MUTATES,smtp_client:MUTATES","db:INSERT:sent_emails:EXACTLY_ONCE_PER_KEY,api:POST:smtp.send:EXACTLY_ONCE_PER_KEY,event:PUBLISH:email.sent.v1:EXACTLY_ONCE_PER_KEY","Draft exists; Email sent via SMTP; Sent record created; Event emitted","DRY_RUN,SHADOW,FULL",60,"max:5,retryable:[HTTP_5xx,SMTP_TEMP_FAIL],backoff:EXP",30,1000,HIGH,"redact:body,redact:to",platform-team,email.sent.v1,,email.state.md,USER,policies/user-send-access.yaml,email_send_success_total,rate(email_send_errors_total[5m]) > 0.1,runbooks/email-send-rollback.md,user:{user_id}:sent,sent_emails:365d
email-worker,backend,process_background_jobs,job.id,job.id + job_type,"GLOBAL","job_id:uuid,job_type:string,payload:json","jobs_queue:MUTATES,various:MUTATES","queue:DEQUEUE:jobs:EXACTLY_ONCE_PER_KEY,db:UPDATE:jobs:EXACTLY_ONCE_PER_KEY","Job processed exactly once; Job status updated; Retries respect backoff policy","DRY_RUN,FULL",,,"max:10,retryable:[TRANSIENT_ERROR],backoff:EXP",120,2000,MED,,infra-team,,email.ingested.v1;email.sent.v1,job.state.md,GLOBAL,policies/worker-access.yaml,background_jobs_processed_total,rate(background_jobs_failed_total[10m]) > 0.15,runbooks/worker-restart.md,jobs:pending,job_logs:30d
inbox-view,frontend,render_inbox,user_id,,,user_id:uuid,"email-search:READONLY","api:GET:/api/emails:AT_LEAST_ONCE_PER_KEY","Shows user's emails only; Handles pagination; Displays loading/error states",,5,,,150,MED,,frontend-team,,,,USER,policies/user-data-access.yaml,inbox_view_render_time_p95,inbox_view_render_time_p95 > 300,runbooks/frontend-degradation.md,user:{user_id}:inbox,
compose-view,frontend,compose_email,draft_id,,,draft_id:uuid,"email-send:MUTATES","api:POST:/api/emails/send:EXACTLY_ONCE_PER_KEY,localStorage:WRITE:draft:AT_LEAST_ONCE_PER_KEY","Validates email format; Shows send confirmation; Clears draft on success; Handles offline mode",,10,,,500,HIGH,redact:compose_body,frontend-team,,,,USER,policies/user-send-access.yaml,email_compose_success_total,rate(email_compose_errors_total[5m]) > 0.1,runbooks/compose-troubleshooting.md,user:{user_id}:draft,drafts:7d
k8s-email-api,infra,deploy_email_api,deployment.name + deployment.version,deployment.name + deployment.version + timestamp,SUBJECT:deployment.name,"deployment_name:string,version:string,replicas:int,namespace:string","k8s_cluster:MUTATES,docker_registry:READONLY","infra:APPLY:k8s.deployment:EXACTLY_ONCE_PER_KEY,infra:APPLY:k8s.service:EXACTLY_ONCE_PER_KEY","Deployment exists with correct replicas; Service routes to deployment; Health checks pass; Zero-downtime rollout","DRY_RUN,CANARY,FULL",300,"max:2,retryable:[K8S_CONFLICT],backoff:CONST",180,5000,HIGH,,devops-team,deployment.applied.v1,,deployment.state.md,GLOBAL,policies/k8s-deploy-access.yaml,deployment_success_total,deployment_success_total == 0,runbooks/k8s-rollback.md,k8s:deployment:{name},deployment_logs:90d
